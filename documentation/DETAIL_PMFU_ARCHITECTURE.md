# üìã DetailPmfuComponent - Architecture et Documentation Compl√®te

## üìã Vue d'ensemble

Le `DetailPmfuComponent` est un composant de dialogue complexe pour la gestion des projets MFU (Ma√Ætrise Fonci√®re et d'Usage). Il combine la gestion de formulaires, l'upload de documents, la visualisation cartographique et la gestion d'√©tats multiples.

**Statistiques du composant :**
- **Lignes de code :** ~770 lignes
- **Imports :** 25+ modules Angular Material
- **M√©thodes publiques :** 15
- **M√©thodes priv√©es :** 4
- **ViewChild :** 4 composants enfants
- **Modes de fonctionnement :** 3 (Consultation, √âdition, Cr√©ation)
- **Types de fichiers g√©r√©s :** Documents + Images

---

## üèóÔ∏è Architecture G√©n√©rale

```mermaid
graph TB
    subgraph "INPUTS"
        I1[MAT_DIALOG_DATA]
        I2[ProjetsMfu | number]
    end

    subgraph "CORE COMPONENT"
        DC[DetailPmfuComponent]
    end

    subgraph "CHILD COMPONENTS"
        MAP[MapComponent]
        FILE[FileExploratorComponent]
        FORM[FormButtonsComponent]
    end

    subgraph "SERVICES"
        FS[FoncierService]
        FORM_S[FormService]
        DOC[DocfileService]
        LOGIN[LoginService]
        CONF[ConfirmationService]
    end

    subgraph "STATES"
        LOADING[isLoading]
        EDIT[isEditPmfu]
        NEW[newPmfu]
        VALID[isFormValid]
    end

    I1 --> DC
    I2 --> DC
    DC --> MAP
    DC --> FILE
    DC --> FORM
    DC --> FS
    DC --> FORM_S
    DC --> DOC
    DC --> LOGIN
    DC --> CONF
    DC --> LOADING
    DC --> EDIT
    DC --> NEW
    DC --> VALID
```

---

## üîÑ Cycle de Vie du Composant

### 1. Initialisation Compl√®te

```mermaid
sequenceDiagram
    participant User
    participant Component
    participant Services
    participant Forms
    participant Files

    User->>Component: ngOnInit()
    Component->>Services: docfileService.loadDocTypes()
    Component->>Services: formService.getSelectValues()
    Component->>Component: Analyse data (nouveau/existant)
    
    alt Projet existant
        Component->>Services: fetch(pmfu_id)
        Component->>Forms: setupPmfuForm()
        Component->>Files: initializeAllowedTypes()
    else Nouveau projet
        Component->>Forms: newPmfuForm()
        Component->>Component: isEditPmfu = true
    end
    
    Component->>Forms: formStatusSubscription
    Component->>Component: isLoading = false
```

### 2. Cha√Ænage d'Initialisation

```
ngOnInit()
‚îú‚îÄ‚îÄ docfileService.loadDocTypes(1)
‚îú‚îÄ‚îÄ formService.getSelectValues$('salaries')
‚îú‚îÄ‚îÄ Analyse this.projetLite
‚îÇ
‚îú‚îÄ‚îÄ SI PROJET EXISTANT:
‚îÇ   ‚îú‚îÄ‚îÄ setTimeout(loadingDelay)
‚îÇ   ‚îú‚îÄ‚îÄ setupPmfuForm()
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fetch(pmfu_id)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ updatePmfuTitle()
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ formService.newPmfuForm(pmfu)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docForm = newDocForm(pmfu)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ foldersSubject.next(newFolders)
‚îÇ   ‚îî‚îÄ‚îÄ formStatusSubscription
‚îÇ
‚îî‚îÄ‚îÄ SI NOUVEAU PROJET:
    ‚îú‚îÄ‚îÄ newPmfu = true
    ‚îú‚îÄ‚îÄ isEditPmfu = true
    ‚îú‚îÄ‚îÄ pmfuForm = newPmfuForm(undefined, 0)
    ‚îú‚îÄ‚îÄ docForm = newDocForm()
    ‚îú‚îÄ‚îÄ patchValue(responsable, createur)
    ‚îî‚îÄ‚îÄ formStatusSubscription
```

---

## üìù Syst√®me de Formulaires

### Architecture des Formulaires

```mermaid
graph TD
    A[DetailPmfuComponent] --> B[pmfuForm - FormGroup]
    A --> C[docForm - FormGroup]
    A --> D[initialFormValues - ProjetMfu]
    
    B --> E[Donn√©es projet MFU]
    E --> F[pmfu_nom]
    E --> G[pmfu_responsable]
    E --> H[pmfu_createur]
    E --> I[...]
    
    C --> J[Documents/Photos]
    J --> K[photos_site]
    J --> L[projet_acte]
    J --> M[decision_bureau]
    J --> N[note_bureau]
```

### √âtats du Formulaire

| √âtat | Description | D√©clencheur |
|------|-------------|-------------|
| `isFormValid` | Validit√© du formulaire principal | `formStatusSubscription` |
| `isEditPmfu` | Mode √©dition activ√© | `toggleEditPmfu()` |
| `newPmfu` | Cr√©ation nouveau projet | Constructeur |
| `isLoading` | Chargement en cours | Async operations |

---

## üìÇ Syst√®me de Gestion de Fichiers

### Architecture des Documents

```mermaid
graph TD
    A[Syst√®me de Fichiers] --> B[DocfileService]
    A --> C[Types de Documents]
    A --> D[Validation Fichiers]
    
    B --> E[loadDocTypes]
    B --> F[handleDocfileSubmission]
    B --> G[submitDocfiles]
    
    C --> H[photos_site]
    C --> I[projet_acte]
    C --> J[decision_bureau]
    C --> K[note_bureau]
    
    D --> L[isFileTypeAllowed]
    D --> M[allowedTypes]
    D --> N[fileErrors]
```

### Cha√Ænage Upload de Fichiers

```
onFileSelected() / onFileDropped()
    ‚îú‚îÄ‚îÄ isFileTypeAllowed(file, field)
    ‚îÇ   ‚îú‚îÄ‚îÄ V√©rification allowedTypes[field]
    ‚îÇ   ‚îú‚îÄ‚îÄ Extension autoris√©e ?
    ‚îÇ   ‚îî‚îÄ‚îÄ Ajout fileErrors si refus
    ‚îÇ
    ‚îú‚îÄ‚îÄ docfileService.onFileSelected()
    ‚îú‚îÄ‚îÄ filesNames.push([fileName, controlName])
    ‚îÇ
    ‚îî‚îÄ‚îÄ onSubmit()
        ‚îî‚îÄ‚îÄ docfileService.handleDocfileSubmission()
            ‚îú‚îÄ‚îÄ Upload vers serveur
            ‚îú‚îÄ‚îÄ Mise √† jour base de donn√©es
            ‚îî‚îÄ‚îÄ fileExplorator.updateFolderCounts()
```

### Types de Fichiers Support√©s

```typescript
defaultExtensions = {
  doc: ['.pdf', '.doc', '.docx'],    // Documents
  image: ['.jpg', '.jpeg', '.png']   // Images
}

// Auto-d√©tection bas√©e sur le nom du champ :
// Si contient "photo" ou "image" ‚Üí type image
// Sinon ‚Üí type document
```

---

## üó∫Ô∏è Int√©gration Cartographique

### Synchronisation Map ‚Üî Toggles

```mermaid
sequenceDiagram
    participant HTML as HTML Toggle
    participant Comp as DetailPmfuComponent
    participant Map as MapComponent
    participant LC as Layer Control

    Note over HTML,LC: Activation via Toggle HTML
    HTML->>Comp: toggleSitesCenca()
    Comp->>Map: synchronizeSitesCencaLayer(true)
    Map->>Map: Mise √† jour layer + chargement
    
    Note over HTML,LC: Activation via Layer Control
    LC->>Map: overlayadd event
    Map->>Comp: sitesCencaToggled.emit(true)
    Comp->>HTML: afficherSitesCenca = true
```

### Variables Cartographiques

```typescript
// √âtat des couches CENCA
afficherSitesCenca: boolean = false;        // Couche color√©e
afficherSitesCencaSites: boolean = false;   // Couche verte

// Gestionnaires de synchronisation
onSitesCencaToggled(active: boolean)        // ‚Üê MapComponent
onSitesCencaSitesToggled(active: boolean)   // ‚Üê MapComponent

// Actions utilisateur
toggleSitesCenca()                          // ‚Üí MapComponent
toggleSitesCencaSites()                     // ‚Üí MapComponent
```

---

## üíæ Gestion des Donn√©es

### Flux de Sauvegarde

```mermaid
graph TD
    A[onSubmit] --> B{newPmfu?}
    
    B -->|false| C[Mode Modification]
    C --> D[formService.putBdd 'update']
    D --> E[handleDocfileSubmission]
    E --> F[setupPmfuForm refresh]
    
    B -->|true| G[Mode Cr√©ation]
    G --> H[formService.putBdd 'insert']
    H --> I[dialogRef.close]
    I --> J[handleDocfileSubmission async]
```

### API Endpoints

| Action | Route | M√©thode | Param√®tres |
|--------|-------|---------|------------|
| R√©cup√©ration | `pmfu/id=${pmfu_id}/full` | GET | pmfu_id |
| Cr√©ation | `projets_mfu` | POST | FormData |
| Modification | `projets_mfu` | PUT | pmfu_id + FormData |
| Suppression | `pmfu/${pmfu_id}` | DELETE | pmfu_id |

---

## üéõÔ∏è Modes de Fonctionnement

### 1. Mode Consultation (D√©faut)

```typescript
isEditPmfu = false
newPmfu = false
// ‚Üí Formulaires d√©sactiv√©s
// ‚Üí Boutons "√âditer" et "Supprimer" visibles
// ‚Üí Carte et fichiers en lecture seule
```

### 2. Mode √âdition

```typescript
isEditPmfu = true
newPmfu = false
// ‚Üí Formulaires activ√©s
// ‚Üí Boutons "Sauvegarder" et "Annuler"
// ‚Üí Upload de fichiers possible
// ‚Üí Int√©gration carte compl√®te
```

### 3. Mode Cr√©ation

```typescript
isEditPmfu = true
newPmfu = true
// ‚Üí Formulaire vide pr√©-rempli
// ‚Üí Responsable = utilisateur connect√©
// ‚Üí Sauvegarde ‚Üí Fermeture dialogue
// ‚Üí Upload diff√©r√© apr√®s cr√©ation
```

---

## üìä Services et D√©pendances

### Services Principaux

| Service | R√¥le | M√©thodes Utilis√©es |
|---------|------|-------------------|
| `FoncierService` | API PMFU | getProjetMfu(), deletePmfu() |
| `FormService` | Gestion formulaires | newPmfuForm(), putBdd(), getSelectValues$() |
| `DocfileService` | Gestion fichiers | loadDocTypes(), handleDocfileSubmission() |
| `LoginService` | Authentification | user() |
| `ConfirmationService` | Dialogues | confirm() |

### Composants Enfants

```typescript
@ViewChild(MapComponent) mapComponent!;
@ViewChild(FileExploratorComponent) fileExplorator!;
@ViewChild('fileInput') fileInput!: ElementRef;
@ViewChild('docxContainer') docxContainer!: ElementRef;
```

---

## üîÑ Gestion d'√âtats Complexes

### Variables d'√âtat Critiques

```typescript
// √âtats principaux
isLoading: boolean = true;              // Chargement initial
isEditPmfu: boolean = false;            // Mode √©dition
newPmfu: boolean = false;               // Nouveau projet
isFormValid: boolean = false;           // Validit√© formulaire

// √âtats de fichiers
isDragging: boolean = false;            // Drag & drop actif
filesNames: string[][] = [];           // Fichiers s√©lectionn√©s
fileErrors: Record<string, string[]>;   // Erreurs par champ

// √âtats de documents
folders: Section[] = [];                // Dossiers avec compteurs
selectedFolder?: number;                // Dossier s√©lectionn√©
galerie?: string[];                     // Images en galerie
```

### Observables et Subscriptions

```typescript
// R√©activit√© formulaire
formStatusSubscription: Subscription
formService.statusChanges.subscribe()

// Donn√©es de s√©lection
formService.getSelectValues$('salaries')
salaries: SelectValue[]

// Gestion des dossiers
foldersSubject = BehaviorSubject<Section[]>([])
folders$ = foldersSubject.asObservable()
```

---

## üé® Interface Utilisateur

### Composants Material Utilis√©s

- **Navigation :** MatStepper avec orientation responsive
- **Formulaires :** MatInput, MatSelect, MatDatepicker, MatSlideToggle
- **Actions :** MatButton, MatIcon
- **Affichage :** MatList, MatProgressSpinner
- **Dialogue :** MatDialog avec backdrop personnalis√©

### Responsive Design

```typescript
// D√©tection mobile/desktop
private breakpointObserver: BreakpointObserver
StepperOrientation // Adaptatif selon √©cran
```

---

## üîß Fonctions Utilitaires et Helpers

### Gestion des Fichiers

```typescript
// Validation type fichier
isFileTypeAllowed(file: File, field: string): boolean
‚îú‚îÄ‚îÄ V√©rification allowedTypes[field]
‚îú‚îÄ‚îÄ Extension dans liste autoris√©e ?
‚îî‚îÄ‚îÄ Gestion fileErrors[field]

// Initialisation types autoris√©s
initializeAllowedTypes(): void
‚îú‚îÄ‚îÄ Analyse doc_types
‚îú‚îÄ‚îÄ D√©tection image vs document
‚îî‚îÄ‚îÄ Mapping vers defaultExtensions

// Suppression fichier
removeDroppedFile(fileToRemove: [string, string])
‚îú‚îÄ‚îÄ Mise √† jour filesNames
‚îú‚îÄ‚îÄ Mise √† jour FormControl
‚îî‚îÄ‚îÄ updateValueAndValidity()
```

### Gestion du Formulaire

```typescript
// Basculement mode √©dition
toggleEditPmfu(): void
‚îú‚îÄ‚îÄ formService.simpleToggle(isEditPmfu)
‚îú‚îÄ‚îÄ formService.toggleFormState()
‚îú‚îÄ‚îÄ Gestion formStatusSubscription
‚îî‚îÄ‚îÄ cdr.detectChanges()

// Configuration formulaire projet
setupPmfuForm(): Promise<void>
‚îú‚îÄ‚îÄ fetch(pmfu_id) ‚Üí ProjetMfu
‚îú‚îÄ‚îÄ updatePmfuTitle()
‚îú‚îÄ‚îÄ newPmfuForm(pmfu) + newDocForm(pmfu)
‚îú‚îÄ‚îÄ Mapping doc_types ‚Üí folders
‚îî‚îÄ‚îÄ foldersSubject.next(newFolders)
```

---

## üö® Gestion d'Erreurs et Validation

### Strat√©gies d'Erreurs

```typescript
// Erreurs de fichiers
fileErrors: Record<string, string[]>
‚îú‚îÄ‚îÄ Validation en temps r√©el
‚îú‚îÄ‚îÄ Affichage temporaire (3s)
‚îî‚îÄ‚îÄ Nettoyage automatique

// Erreurs r√©seau
HTTP Error ‚Üí FormService.putBdd()
‚îú‚îÄ‚îÄ MatSnackBar notification
‚îú‚îÄ‚îÄ Gestion success/failure
‚îî‚îÄ‚îÄ Rollback automatique si √©chec

// Erreurs de validation
formStatusSubscription
‚îú‚îÄ‚îÄ isFormValid en temps r√©el
‚îú‚îÄ‚îÄ D√©sactivation boutons si invalide
‚îî‚îÄ‚îÄ Feedback visuel immediate
```

### Points de Validation

1. **Formulaire principal :** Validation Angular reactive
2. **Types de fichiers :** Extension + taille
3. **Authentification :** Utilisateur connect√© requis
4. **Donn√©es obligatoires :** Nom projet, responsable
5. **Suppression :** Confirmation utilisateur

---

## ‚ö° Optimisations et Performance

### Optimisations Impl√©ment√©es

```typescript
// D√©lai de chargement artificiel
loadingDelay: number = 400;
setTimeout(async () => { /* setup */ }, loadingDelay);

// Change Detection
cdr.detectChanges() // Force le rendu
setTimeout(() => this.cdr.detectChanges(), 0); // Async

// Observables cleanup
formStatusSubscription?.unsubscribe()

// Lazy loading
if (this.fileExplorator) {
  this.fileExplorator.updateFolderCounts();
}
```

### Gestion M√©moire

- **Subscriptions :** Nettoyage explicite des souscriptions
- **ViewChild :** V√©rification existence avant utilisation
- **Timeout :** Gestion des d√©lais et cleanup
- **Change Detection :** Optimis√© avec OnPush quand possible

---

## üéØ Points d'Extension

### Ajouter un Nouveau Type de Document

1. **Backend :** Ajouter dans table doc_types
2. **Interface :** √âtendre Section interface si besoin
3. **Formulaire :** Auto-d√©tection via initializeAllowedTypes()
4. **Upload :** handleDocfileSubmission() g√®re automatiquement

### Ajouter une Nouvelle Validation

```typescript
// Dans isFileTypeAllowed()
const maxSize = 10 * 1024 * 1024; // 10MB
if (file.size > maxSize) {
  this.fileErrors[field].push('Fichier trop volumineux');
  return false;
}
```

### Int√©grer un Nouveau Service

```typescript
constructor(
  // ... services existants
  private nouveauService: NouveauService
) {}

// Utilisation dans ngOnInit() ou autres m√©thodes
```

---

## üìã Configuration et Constantes

### Configuration Dialogue

```typescript
dialogConfig = {
  width: '580px',
  height: '220px',
  hasBackdrop: true,
  backdropClass: 'custom-backdrop-delete',
  enterAnimationDuration: '3000ms',
  exitAnimationDuration: '300ms',
};
```

### Extensions Autoris√©es

```typescript
defaultExtensions: Record<string, string[]> = {
  doc: ['.pdf', '.doc', '.docx'],
  image: ['.jpg', '.jpeg', '.png']
};
```

---

## üîß Maintenance et Debug

### Points de Debug Critiques

```typescript
// √âtats √† surveiller
console.log('isEditPmfu:', this.isEditPmfu);
console.log('newPmfu:', this.newPmfu);
console.log('isFormValid:', this.isFormValid);
console.log('isLoading:', this.isLoading);

// Donn√©es formulaire
console.log('pmfuForm.value:', this.pmfuForm.value);
console.log('docForm.value:', this.docForm.value);

// Fichiers
console.log('filesNames:', this.filesNames);
console.log('fileErrors:', this.fileErrors);
console.log('allowedTypes:', this.allowedTypes);

// Synchronisation carte
console.log('afficherSitesCenca:', this.afficherSitesCenca);
console.log('mapComponent exists:', !!this.mapComponent);
```

### Probl√®mes Courants

1. **Formulaire invalide :** V√©rifier formStatusSubscription
2. **Fichiers refus√©s :** Contr√¥ler allowedTypes et extensions
3. **Carte non synchronis√©e :** V√©rifier ViewChild MapComponent
4. **Upload √©chou√© :** Examiner handleDocfileSubmission logs
5. **Donn√©es manquantes :** V√©rifier fetch() et setupPmfuForm()

---

## üìà M√©triques et Statistiques

**Complexit√© du Composant :**
- üéØ **Complexit√© :** Tr√®s √©lev√©e (770+ lignes, multiples responsabilit√©s)
- üîÑ **√âtats g√©r√©s :** 15+ variables d'√©tat
- üìù **Formulaires :** 2 FormGroup principaux + validation
- üìÇ **Types fichiers :** 4 types documents + validation
- üó∫Ô∏è **Int√©gration carte :** Synchronisation bidirectionnelle
- ‚ö° **Performance :** Optimis√©e (lazy loading, change detection)
- üîó **Couplage :** Mod√©r√© (5 services + 4 ViewChild)

**Patterns Utilis√©s :**
- Observer Pattern (formStatusSubscription)
- Strategy Pattern (allowedTypes)
- Factory Pattern (FormService)
- Command Pattern (onSubmit actions)
- Template Method (setupPmfuForm)

---

*Documentation g√©n√©r√©e le 17 octobre 2025*
*DetailPmfuComponent v1.0 - Composant de gestion projet MFU complet*