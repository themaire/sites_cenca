<mat-dialog-content class="dialogue" *ngIf="!isLoading; else loading">
  <div class="conteneur-projet">
    <div class="proteger"><p>Prot√©ger</p></div>
    <div class="projet">
      <!-- -- Variable isEditProjet : {{ isEditProjet }}<br>
      -- Variable isEditProjet : {{ isEditProjet }}<br>
      -- Variable isEditObjectif : {{ isEditObjectif }}<br>
      -- Variable isAddObjectif : {{ isAddObjectif }}<br>
      -- Variable isEditOperation : {{ isEditOperation }}<br>
      -- Variable isAddOperation : {{ isAddOperation }}<br>
      -- Variable newProjet : {{ newProjet }}<br>
      <ng-container *ngIf="projet?.pro_webapp">-- pro_webapp : {{ projet?.pro_webapp }}<br></ng-container> -->

      <ng-container *ngTemplateOutlet="stepper"></ng-container>
    </div>
  </div>
</mat-dialog-content>

<ng-template #stepper>
  <div class="example-input-wrapper">
    <!-- <label for="duration">Animation duration:</label> -->
    <input
      hidden
      id="duration"
      value="300"
      type="number"
      min="0"
      step="100"
      #duration
    />
  </div>
  <!-- Boutons de controle, titre et bouton de suppression -->
  <div
    class="button-title"
    [class.center-title]="
      pmfu === undefined || pmfu === null || isEditPmfu || isAddPmfu
    "
  >
    <!-- 1er element -->
    <div class="buttons-container">
      <div class="form-buttons">
        <app-form-buttons
          [isEditActive]="isEditPmfu"
          icone="edit"
          [theme]="'proteger'"
          [isFormValid]="isFormValid"
          (toggleAction)="toggleEditPmfu()"
          (onSubmit)="onSubmit()"
        ></app-form-buttons>
      </div>
      <div class="suppression" *ngIf="!isAddPmfu && !newPmfu">
        <button mat-button (click)="deletePmfuConfirm()">
          Supprimer le projet
        </button>
      </div>
    </div>
    <!-- 2eme element -->
    <div class="title-container">
      <ng-container
        *ngTemplateOutlet="newPmfu ? newTitle : title"
      ></ng-container>
    </div>

    <ng-template #title>
      <div class="title-wrapper">
        <h2 *ngIf="!isEditPmfu">Consultation du Projet MFU</h2>
        <h2 *ngIf="isEditPmfu">Modification du Projet MFU</h2>
        <h2 *ngIf="!newPmfu">{{ pmfuTitle }}</h2>
      </div>
    </ng-template>
    <ng-template #newTitle>
      <h2 *ngIf="newPmfu">Cr√©ation d'un projet neuf en cours</h2>
    </ng-template>
  </div>
  <mat-horizontal-stepper
    [linear]="false"
    #mfuStepper
    [animationDuration]="duration.value"
  >
    <!-- √âtape 1: Informations principales -->
    <mat-step>
      <ng-template matStepLabel>Informations principales</ng-template>

      <!-- Formulaire mutualis√© √©dition/lecture seule -->
      <form [formGroup]="pmfuForm" class="first-step">
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Nom du projet</mat-label>
            <input matInput formControlName="pmfu_nom" [readonly]="!isEditPmfu" />
          </mat-form-field>
        </div>
        <div class="form-row">

          <mat-form-field appearance="fill">
            <mat-label>Responsable</mat-label>
            <ng-container *ngIf="isEditPmfu; else responsableReadonly">
              <mat-select formControlName="pmfu_responsable">
                <mat-option *ngFor="let salarie of salaries" [value]="salarie.cd_type">
                  {{ salarie.libelle }}
                </mat-option>
              </mat-select>
            </ng-container>
            <ng-template #responsableReadonly>
              <input matInput [value]="formService.getLibelleByCdType(pmfuForm.get('pmfu_responsable')?.value, salaries)" readonly />
            </ng-template>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Cr√©ateur du projet</mat-label>
            <input matInput formControlName="pmfu_createur" [readonly]="!isEditPmfu" />
          </mat-form-field>

        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Coll√®gue associ√©</mat-label>
            <input matInput formControlName="pmfu_associe" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Agence</mat-label>
            <input matInput formControlName="pmfu_agence" [readonly]="!isEditPmfu" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Territoire</mat-label>
            <input matInput formControlName="pmfu_territoire" [readonly]="!isEditPmfu" />
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>D√©partement</mat-label>
            <ng-container *ngIf="isEditPmfu; else departementReadonly">
              <mat-select formControlName="pmfu_departement">
                <mat-option value="08">Ardennes</mat-option>
                <mat-option value="10">Aube</mat-option>
                <mat-option value="51">Marne</mat-option>
                <mat-option value="52">Haute-Marne</mat-option>
              </mat-select>
            </ng-container>
            <ng-template #departementReadonly>
              <input matInput [value]="getDepartementLibelle(pmfuForm.get('pmfu_departement')?.value)" readonly />
            </ng-template>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Commune</mat-label>
            <ng-container *ngIf="isEditPmfu; else communeReadonly">
              <input type="text" matInput [formControl]="communeCtrl" [matAutocomplete]="auto" />
              <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayCommune">
                <mat-option *ngFor="let commune of filteredCommunes" [value]="commune">
                  {{ commune.nom }}
                </mat-option>
              </mat-autocomplete>
            </ng-container>
            <ng-template #communeReadonly>
              <input matInput [value]="communeInsee ? communeInsee.nom : ''" readonly />
            </ng-template>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Superficie (ha)</mat-label>
            <input matInput formControlName="pmfu_superficie" type="number" [readonly]="!isEditPmfu" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Ann√©e de d√©but</mat-label>
            <input matInput formControlName="pmfu_debut" type="number" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Type</mat-label>
            <input matInput formControlName="pmfu_type" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Propri√©taire</mat-label>
            <input matInput formControlName="pmfu_proprietaire" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Mesures compensatoires</mat-label>
            <input matInput formControlName="pmfu_compensatoire" [readonly]="!isEditPmfu" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Co√ªt estim√©</mat-label>
            <input matInput formControlName="pmfu_cout" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Financements envisag√©s</mat-label>
            <input matInput formControlName="pmfu_financements" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Validation bureau/CA</mat-label>
            <input matInput formControlName="pmfu_validation" [readonly]="!isEditPmfu" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Besoin d'appui</mat-label>
            <input matInput formControlName="pmfu_appui" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Priorit√©</mat-label>
            <input matInput formControlName="pmfu_priorite" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Status</mat-label>
            <input matInput formControlName="pmfu_status" [readonly]="!isEditPmfu" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Ann√©e de signature</mat-label>
            <input matInput formControlName="pmfu_signature" type="number" [readonly]="!isEditPmfu" />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>√âch√©ances</mat-label>
            <input matInput formControlName="pmfu_echeances" [readonly]="!isEditPmfu" />
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Prochaines √©tapes</mat-label>
            <textarea matInput formControlName="pmfu_etapes" rows="3" [readonly]="!isEditPmfu"></textarea>
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>D√©tails juridiques</mat-label>
            <textarea matInput formControlName="pmfu_juridique" rows="3" [readonly]="!isEditPmfu"></textarea>
          </mat-form-field>
        </div>
        <div *ngIf="isEditPmfu">
          <button mat-button matStepperNext>Suivant</button>
        </div>
      </form>
    </mat-step>
    
    <!-- √âtape 2: Localisation -->
    <mat-step>
      <ng-template matStepLabel>Localisation</ng-template>

      <!-- <div>
        <ng-container *ngFor="let parcelle of parcellesSelected">
          {{ parcelle.idu }} - {{ parcelle.section }}{{ parcelle.numero }}
        </ng-container>
      </div>
      <div>
        Valeurs du formulaire :
        <ng-container *ngFor="let entry of pmfuForm.value | keyvalue">
          {{ entry.key }} : {{ entry.value }}
        </ng-container>
      </div>
      <div>
        {{ pmfuForm.get('pmfu_parc_list_array')?.value }}
      </div> -->

      <!-- <div>Parcelles selectionn√©es :
          <ng-container *ngFor="let parcelle of parcellesSelected; let i = index">
            Index : {{ i }} | idu : {{ parcelle.idu }}
          </ng-container>
      </div>

      <div>Parcelles Initiales backup :
          <ng-container *ngFor="let parcelle of parcellesInitialesBackup; let i = index">
            Index : {{ i }} | idu : {{ parcelle.idu }}
          </ng-container>
      </div>

      <div>Parcelles Initiales :
          <ng-container *ngFor="let entry of initialparcellesSelected | keyvalue">
          {{ entry.key }} : {{ entry.value }}
        </ng-container>
      </div>

      <div>Parcelles du formulaire :
         <ng-container *ngFor="let entry of pmfuForm.get('pmfu_parc_list_array')?.value | keyvalue">
          {{ entry.key }} : {{ entry.value }}
        </ng-container>
      </div>

      <div>Parcelles Ajout√©es :
         <ng-container *ngFor="let entry of parcellesAjoutees | keyvalue">
          {{ entry.key }} : {{ entry.value }}
        </ng-container>
      </div> -->

      <!-- Contr√¥les pour les sites CENCA -->
      <!-- <div class="carte-controls">
        Afficher dynamiquement :
        <div class="toggles-container">
          <mat-slide-toggle 
            [(ngModel)]="afficherSitesCencaSites"
            (change)="toggleSitesCencaSites()">
            üü¢ Les sites CENCA (g√©r√©s en verts)
          </mat-slide-toggle>

          <mat-slide-toggle 
            [(ngModel)]="afficherSitesCenca"
            (change)="toggleSitesCenca()">
            üåø Les autres sites (CAST et autres en jaune)
          </mat-slide-toggle>
        </div> -->

        <!-- Parcelles s√©lectionn√©es (selectionn√©es a l'instant pr√©sent ou charg√©e depuis le bdd). -->
        <div *ngIf="parcellesSelected.length >= 0" class="parcelles-selected" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
          <span style="font-weight: bold; margin-right: 8px;">Parcelles s√©lectionn√©es :</span>
          
          <ng-container *ngFor="let parcelle of parcellesSelected">
            <div class="parcelle-info" style="background: #f5eee8; border-radius: 6px; padding: 4px 10px; margin-bottom: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); display: flex; align-items: center; min-height: 40px;">
              <div class="zoom-wrapper" (click)="zoomToParcelle(parcelle)" title="Zoomer sur cette parcelle" style="margin-right: 8px; cursor: pointer;">
                <mat-icon class="zoom-icon" color="primary">zoom_in</mat-icon>
              </div>
              {{ parcelle.nom_com }} {{ parcelle.section }} - {{ parcelle.numero }} - {{ parcelle.idu }}
              <div class="delete-wrapper" (click)="removeParcelle(parcelle)" title="Supprimer cette parcelle">
                <mat-icon *ngIf="isEditPmfu" class="delete-icon">delete</mat-icon>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- <div>pmfuForm.get('pmfu_parc_list_array')?.value : {{pmfuForm.get('pmfu_parc_list_array')?.value}}</div>
        <div>parcellesSelected : {{parcellesSelected}}</div> -->
        
        <!-- <div class="sites-info" *ngIf="afficherSitesCenca || afficherSitesCencaSites">
          <mat-hint *ngIf="afficherSitesCencaSites">üü¢ Sites CENCA Sites se chargent automatiquement !</mat-hint>
          <mat-hint *ngIf="afficherSitesCenca">üåø Sites CENCA autres dynamiques se chargent automatiquement !</mat-hint>
        </div> -->

      <div class="map-container">
        <app-map 
          [isEditMode]="isEditPmfu"
          [mapName]="'pmfu-' + (pmfu ? pmfu.pmfu_id : 'nouveau')"
          [chargerSitesDynamiquement]="afficherSitesCenca"
          [chargerSitesSitesDynamiquement]="afficherSitesCencaSites"
          [chargerParcellesDynamiquement]="true"
          [selectParcellesMode]="selectParcellesMode"
          [parcellesSelectedInitiales]="parcellesSelected"
          (sitesCencaToggled)="onSitesCencaToggled($event)"
          (sitesCencaSitesToggled)="onSitesCencaSitesToggled($event)"
          (parcellesToggled)="onParcellesToggled($event)"
          (parcellesSelected)="onParcellesSelected($event)"
          (parcelleRemoved)="onParcelleRemoved($event)"
          style="height: 500px; width: 100%; border: 1px solid #ccc; border-radius: 4px;">
        </app-map>
      </div>
      <div class="step-actions">
        <button mat-button matStepperPrevious>Pr√©c√©dent</button>
        <button mat-button matStepperNext>Suivant</button>
      </div>
    </mat-step>
    
    <!-- √âtape 3: Pi√®ces jointes -->
    <mat-step>
      <ng-template matStepLabel>Pi√®ces jointes</ng-template>
<form [formGroup]="pmfuForm" class="second-step" *ngIf="isEditPmfu">
  <div class="form-row">

    @for (type of doc_types; track type.cd_type) {
      <div
        class="form-field upload"
        (drop)="onFileDropped($event, type.field)"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
      >
        <label [for]="type.field">
          {{ type.libelle }}
          <br />
          <small>({{ allowedTypes[type.field].join(', ') || 'Fichiers autoris√©s inconnus' }})</small>
        </label>

        <input
          type="file"
          [id]="type.field"
          (change)="onFileSelected($event, type.field)"
          [accept]="allowedTypes[type.field].join(',')"
          multiple
          class="hidden"
        />

        <label [for]="type.field" class="drop-zone">
          <mat-icon class="upload-icon">upload_file</mat-icon>
          <span class="drop-text">
            Glissez-d√©posez vos fichiers ou cliquez
          </span>
        </label>

        <div *ngIf="fileErrors[type.field]?.length" class="error-messages">
          <div *ngFor="let err of fileErrors[type.field]" class="error-text">
            {{ err }}
          </div>
        </div>

        <mat-list class="upload-list">
          @for (file of filesNames; track file[0]) {
            <mat-list-item *ngIf="file[1] === type.field" class="upload-list-item">
              <div class="upload-list-item">
                <div matListItemTitle>- {{ file[0] }}</div>
                <button mat-icon-button (click)="removeDroppedFile([file[0], file[1]])">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </mat-list-item>
          }
        </mat-list>
      </div>
    }

  </div>

  <input type="hidden" formControlName="pmfu_id" />
</form>

      <form [formGroup]="pmfuForm" class="second-step" *ngIf="!isEditPmfu">
        <app-file-explorator
        [section]="1"
        [referenceId]="pmfu.pmfu_id"
        ></app-file-explorator>
      </form>
    </mat-step>
  </mat-horizontal-stepper>
</ng-template>
<ng-template #loading>
  <div class="loading-container">
    <mat-spinner class="spinner-orange"></mat-spinner>
    <p>Chargement ...</p>
  </div>
</ng-template>
