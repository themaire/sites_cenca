<!-- Il y a 2 MODES d'affichage de ce composant -->
<!-- 1 On liste les opérations existantes - grace a l'appel au backend sur les operations lite -->
<!-- 2 On ajoute ou edite une opération existante -->
<!-- this.form est généré vide OU this.form est rempli l'opération -->

<!-- Variable (Input depuis projet) projetEditMode: {{ projetEditMode }}<br>
Variable (operation) isEditOperation: {{ isEditOperation }}<br>
Variable (operation) isAddOperation: {{ isAddOperation }}<br> -->

<!-- Utilisation du template buttons pour ajouter une opération -->
<app-form-buttons
  *ngIf="!projetEditMode"
  icone="add" 
  [isEditActive]="isEditOperation" 
  [isAddActive]="isAddOperation" 
  [isFormValid]="isFormValid" 
  (toggleAction)="toggleEditOperation($event)"
  (makeOperationForm)="makeForm($event)"
  (onSubmit)="onSubmit($event)" 
></app-form-buttons>

<!-- Permet d'appeller un template -->
<ng-container *ngIf="!isEditOperation && !isAddOperation; then listOperations; else addEditOperation"></ng-container>

<!-- MODE 1 -->
<ng-template #listOperations> 

  <div>
    <!-- Si le booleen !isEditOperation && !isAddOperation sont false, on montre la liste des opérations  -->

    Tableau des opérations. Si pâturé (1 opération par parc).
    <ng-container *ngIf="operations !== undefined && operations.length > 0; then table else noOperations"></ng-container>

    <ng-template #table>
      <div>
        Nb opérations : {{ operations.length }}<br>
        <mat-table [dataSource]="dataSourceOperations" class="mat-elevation-z8" #matTable>
          <ng-container matColumnDef="code">
            <mat-header-cell *matHeaderCellDef> Code </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{ element.code }} </mat-cell>
          </ng-container>
          
          <ng-container matColumnDef="titre">
            <mat-header-cell *matHeaderCellDef> Titre </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{ element.titre }} </mat-cell>
          </ng-container>
          
          <ng-container matColumnDef="description">
            <mat-header-cell *matHeaderCellDef> Description </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{ element.description }} </mat-cell>
          </ng-container>
          
          <ng-container matColumnDef="surf">
            <mat-header-cell *matHeaderCellDef> Surface </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{ element.surf }} </mat-cell>
          </ng-container>
          
          <ng-container matColumnDef="date_debut">
            <mat-header-cell *matHeaderCellDef> Date début </mat-header-cell>
            <mat-cell *matCellDef="let element"> {{ element.date_debut }} </mat-cell>
          </ng-container>
          
          <mat-header-row *matHeaderRowDef="displayedColumnsOperations"></mat-header-row>
          <!-- Ouvrir la fenetre de dialogue d'une opération -->
          <mat-row *matRowDef="let operation; columns: displayedColumnsOperations;" (click)="this.makeForm({ operation })"></mat-row>
        </mat-table>
      </div>
    </ng-template>

    <ng-template #noOperations>
        Il n'y a pas d'opérations sur ce site.
    </ng-template>

  </div>
</ng-template>

<!-- MODE 2 -->
<ng-template #addEditOperation>

  <!-- (nom_dans_composant)='mathode à utiliser depuis le composant du bouton' -->

  <mat-horizontal-stepper [linear]="linearMode" #stepper>

    <mat-step [stepControl]="form!">
      <form [formGroup]="form!">
        <ng-template matStepLabel>Type de l'opération</ng-template>
        <div>
          <mat-slide-toggle
                formControlName="validite"
                class="toggle"
                [checked]="form.get('validite')?.value || false"
                [disabled]="false">

                Validité de l'opération

          </mat-slide-toggle>
        </div>
        <div>

          <!-- <mat-form-field>
            <mat-label>Ref UUID Operation</mat-label>
            <input matInput formControlName="uuid_ope" readonly>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Ref UUID Project</mat-label>
            <input matInput formControlName="ref_uuid_proj" readonly>
          </mat-form-field> -->

          <mat-form-field>
            <mat-label>Objectif opérationnel</mat-label>
            <mat-select formControlName="obj_ope">
              @for (type of typeObjectifOpe; track type) {
                <mat-option [value]="type.cd_type">{{type.libelle}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Type d'opération 1</mat-label>
            <mat-select formControlName="action">
              @for (type of operationTypesFamilles; track type) {
                <mat-option [value]="type.cd_type">{{type.libelle}}</mat-option>
                <!-- <mat-option [value]="type.cd_type">{{type.libelle}} -- {{type.cd_type}}</mat-option> -->
              }
            </mat-select>
          </mat-form-field>

          <!-- Differents types d'opérations selon la famille sélectionnée -->
          <ng-container *ngIf="selectedOperationFamille != ''">
            <mat-form-field *ngIf ="selectedOperationFamille !== undefined && selectedOperationFamille == '027_TRAV_MECA_V2'">
              <mat-label>Type d'opération 2</mat-label>
              <mat-select formControlName="action_2">
                @for (type of operationTypesMeca; track type) {
                  <mat-option [value]="type.cd_type">{{type.libelle}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-form-field *ngIf ="selectedOperationFamille !== undefined && selectedOperationFamille == '028_TRAV_PAT_V2'">
              <mat-label>Type d'opération 2</mat-label>
              <mat-select formControlName="action_2">
                @for (type of operationTypesPat; track type) {
                  <mat-option [value]="type.cd_type">{{type.libelle}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-form-field *ngIf ="selectedOperationFamille !== undefined && selectedOperationFamille == '008_TRAV_AMEN_V2'">
              <mat-label>Type d'opération 2</mat-label>
              <mat-select formControlName="action_2">
                @for (type of operationTypesAme; track type) {
                  <mat-option [value]="type.cd_type">{{type.libelle}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-form-field *ngIf ="selectedOperationFamille !== undefined && selectedOperationFamille == '005_TRAV_HYDRO_V2'">
              <mat-label>Type d'opération 2</mat-label>
              <mat-select formControlName="action_2">
                @for (type of operationTypesHydro; track type) {
                  <mat-option [value]="type.cd_type">{{type.libelle}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <mat-form-field *ngIf ="selectedOperationFamille !== undefined && selectedOperationFamille == '200_TRAV_DECH_V2'">
              <mat-label>Type d'opération 2</mat-label>
              <mat-select formControlName="action_2">
                @for (type of operationTypesDech; track type) {
                  <mat-option [value]="type.cd_type">{{type.libelle}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </ng-container>

          <button mat-icon-button matTooltip="Décrire/Détailler l'opération en deux ou trois phrases." class="info-button">
            <mat-icon>info</mat-icon>
          </button>
          <mat-form-field>
            <mat-label>Description (détails)</mat-label>
            <input matInput formControlName="description" placeholder="Exemple :● Fauche avec exportation des rémanents et mise en ballot
            ● Débroussaillage de la végétation ligneuse avec mise en tas des rémanents en lisière.">
            <mat-icon matSuffix (click)="form.get('description')?.setValue('')">clear</mat-icon>
            <mat-error *ngIf="form.get('description')?.hasError('required')">
              Ce champ est obligatoire.
            </mat-error>
            <mat-error *ngIf="form.get('description')?.hasError('minWords')">
              La description doit contenir au moins 2 mots.
            </mat-error>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Remarques particulières</mat-label>
            <input matInput formControlName="remarque" placeholder="Exemple :● En raison des conditions hydriques exceptionnelles de cette année, la fauche a eu lieu tardivement en saison
● Dégradation du site par des engins sylvicoles.">
            <mat-icon matSuffix (click)="form.get('remarque')?.setValue('')">clear</mat-icon>
            <mat-error *ngIf="form.get('remarque')?.hasError('required')">
              Ce champ est obligatoire.
            </mat-error>
            <mat-error *ngIf="form.get('remarque')?.hasError('minWords')">
              Vos remarques doivent contenir au moins 2 mots.
            </mat-error>
          </mat-form-field>
        </div>
        <div>
          <button mat-button matStepperPrevious>Retour</button>
          <button mat-button matStepperNext>Suivant</button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="form!">
      <form [formGroup]="form!">
        <ng-template matStepLabel>Type de l'intervention</ng-template>
        <div>
          <mat-form-field>
            <mat-label>Maitre d'oeuvre</mat-label>
            <!-- <mat-label>Type d'intervention</mat-label> -->
            <mat-select formControlName="typ_intervention">
              <mat-option *ngFor="let type of maitreOeuvreTypes" [value]="type.cd_type">
                {{ type.libelle }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field>
            <mat-label>Nom du maitre d'oeuvre</mat-label>
            <input matInput formControlName="nom_mo">
          </mat-form-field>
        </div>
        <div>
          Cadre de l'intervention
        </div>
        <div>
          <button mat-button matStepperPrevious>Retour</button>
          <button mat-button matStepperNext>Suivant</button>
        </div>
      </form>
    </mat-step>

    <mat-step state="euro">
      <form [formGroup]="form!">
        <ng-template matStepLabel>Financement</ng-template>
        <div>
          <mat-form-field>
            <mat-label>Financement</mat-label>
            <mat-select formControlName="programme"
                        (selectionChange)="onProgrammeChange($event.value)">
              <mat-option *ngFor="let type of programmeTypes" [value]="type.cd_type">
                {{ type.libelle }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div>
          <button mat-button matStepperPrevious>Précédent</button>
          <button mat-button matStepperNext>Suivant</button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="form!">
      <ng-template matStepLabel>Données spatiales</ng-template>

      <div *ngIf="localisations !== undefined && localisations.length > 0">
        <button mat-button (click)="deleteItem('localisation')">Supprimer la localisation</button>
        <div>
          <app-map mapName='Opération' [geojson_primary]="geojson_site" [geojson_secondary]="localisations[0].geojson"></app-map>
        </div>
      </div>

      <div *ngIf="localisations === undefined || localisations.length === 0">
        Il n'y a pas encore de localisation enregistrée pour cette opération. 
      </div>
      
      <div *ngIf="isAddOperation">
        Merci de terminer cette saisie de nouvel objectif avant d'ajouter une emprise de travaux.
      </div>

      <div *ngIf="isEditOperation && localisations === undefined || localisations !== undefined && localisations.length === 0">
        <button mat-button (click)="downloadShapefileExample()">Télécharger le modèle de fichier shapefile si necessaire</button>
        <form [formGroup]="shapeForm!">
          <div class="file-upload-container">
          <label for="shapefile">Fichier Shapefile (ZIP)</label>
          <input type="file" 
              id="shapefile"
              (change)="onFileSelected($event)" 
              accept=".zip"
              #fileInput>
          </div>
          <input type="hidden" formControlName="type_geometry">
          <input type="hidden" formControlName="uuid_ope">
          <button mat-button 
            (click)="handleShapefileSubmission()"
            [disabled]="!shapeForm?.get('shapefile')?.value">
            <!-- Désactivé si le champ shapefile du formulaire est vide -->
            Envoyer l'emprise
          </button>
        </form>
      </div>

      <button mat-button matStepperPrevious>Retour</button>
      <button mat-button matStepperNext>Suivant</button>
    </mat-step>

    <mat-step [stepControl]="form!">
      <form [formGroup]="form!">
        <ng-template matStepLabel>Champs non utilisés</ng-template>
        <div>

          <mat-form-field>
            <mat-label>Inscrit PDG</mat-label>
            <input matInput formControlName="inscrit_pdg">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Rmq PDG</mat-label>
            <input matInput formControlName="rmq_pdg">
          </mat-form-field>
          
          <mat-form-field>
            <mat-label>Interv ZH</mat-label>
            <input matInput formControlName="interv_zh">
          </mat-form-field>

          <mat-form-field>
            <mat-label>Code</mat-label>
            <input matInput formControlName="code">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Titre</mat-label>
            <input matInput formControlName="titre">
          </mat-form-field>
        </div>

        <div>
          <mat-form-field>
            <mat-label>Surface (ha)</mat-label>
            <input matInput formControlName="surf">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Linéaire</mat-label>
            <input matInput formControlName="lin">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Apport de fourrage</mat-label>
            <input matInput formControlName="app_fourr">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Pression Moyenne</mat-label>
            <input matInput formControlName="pression_moy">
          </mat-form-field>
        </div>

        <div>
          <mat-form-field>
            <mat-label>UGB Moy</mat-label>
            <input matInput formControlName="ugb_moy">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Nbjours</mat-label>
            <input matInput formControlName="nbjours">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Charge Moy</mat-label>
            <input matInput formControlName="charge_moy">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Charge Inst</mat-label>
            <input matInput formControlName="charge_inst">
          </mat-form-field>
        </div>

        <div>
          <mat-form-field>
            <mat-label>Date Debut</mat-label>
            <input matInput formControlName="date_debut" type="date">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Date Fin</mat-label>
            <input matInput formControlName="date_fin" type="date">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Date Approx</mat-label>
            <input matInput formControlName="date_approx">
          </mat-form-field>
        </div>

        <div>
          <mat-form-field>
            <mat-label>Ben Participants</mat-label>
            <input matInput formControlName="ben_participants">
          </mat-form-field>
          <mat-form-field>
            <mat-label>Ben Heures</mat-label>
            <input matInput formControlName="ben_heures">
          </mat-form-field>
        </div>
        <div>
          <button mat-button matStepperPrevious>Retour</button>
        </div>
      </form>
    </mat-step>

    

    
  </mat-horizontal-stepper>
  
  <div>
    <button mat-button (click)="deleteItem('operation')">Supprimer l'opération</button>
  </div>
</ng-template>
